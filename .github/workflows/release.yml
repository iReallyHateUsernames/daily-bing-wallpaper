name: Create Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0, v1.1.0, etc.

jobs:
  build-and-release:
    name: Build and Create Release
    runs-on: windows-latest
    permissions:
      contents: write  # Required to create releases
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install Chocolatey (for Inno Setup)
      run: |
        Set-ExecutionPolicy Bypass -Scope Process -Force
        [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
        iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
      shell: powershell
    
    - name: Install Inno Setup
      run: choco install innosetup -y
      shell: powershell
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pystray pillow
    
    - name: Build main executable
      uses: Nuitka/Nuitka-Action@main
      with:
        nuitka-version: main
        script-name: bing_wallpaper.py
        mode: onefile
        windows-console-mode: disable
        msvc: latest
        lto: yes
        output-dir: dist
        include-module: logger
        output-file: BingWallpaperDownloader.exe
        assume-yes-for-downloads: true
    
    - name: Build tray app executable
      uses: Nuitka/Nuitka-Action@main
      with:
        nuitka-version: main
        script-name: bing_wallpaper_tray.py
        mode: onefile
        windows-console-mode: disable
        msvc: latest
        lto: yes
        output-dir: dist
        include-module: logger
        include-data-files: |
          tray_icon.png=tray_icon.png
          app_icon.ico=app_icon.ico
        output-file: BingWallpaperTray.exe
        assume-yes-for-downloads: true
    
    - name: Build installer
      run: |
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer.iss
      shell: powershell
    
    - name: Get version from tag
      id: get_version
      run: |
        $version = "${{ github.ref_name }}"
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
      shell: powershell
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ steps.get_version.outputs.VERSION }}
        draft: false
        prerelease: false
        files: |
          installer_output/BingWallpaperDownloader_Setup.exe
        body: |
          ## ðŸŽ¨ Bing Wallpaper Downloader ${{ steps.get_version.outputs.VERSION }}
          
          ### ðŸ“¥ Download & Install
          
          Download `BingWallpaperDownloader_Setup.exe` below and run the installer.
          
          ### ðŸ”„ Changes in this Release
          
          See the [commit history](https://github.com/${{ github.repository }}/commits/${{ github.ref_name }}) for details.
          
          ### ðŸ’» Requirements
          - Windows 10 or later
          - ~20MB disk space
          
          ### ðŸ“– Documentation
          
          See the [README](https://github.com/${{ github.repository }}/blob/main/README.md) for full documentation.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
